#講義内容

## MVC
Model・View・Controllerの頭文字をとったものです。
昨今のWebアプリケーションのフレームワークは大抵この思想に乗っ取っていることがほとんどです。

### MVCで実装されているフレームワーク(ごく一部)
- Ruby On Rails (Ruby)
- Spring Framework (Java)
- Play Framework (Scala/Java)
- Fuel PHP (PHP)
- ASP.net MVC (.NET (C#/VB.NET))
- ...


#### Controller
ユーザーからの操作を起点に動作します。  
Webアプリケーションの場合、URLと対応することになります。  
役割としてはユーザーから受け取った値を元に、  
Modelの値を操作し、 Viewに渡すといった流れになります。  
前回の授業で実装したUserResouce.javaもここに含まれます。  

#### View
以下で説明するModelの値の表示を行います。  
前回の授業ではREST APIを作っただけだったので、  
Viewの実装はありませんでした。  

#### Model
雑に言ってしまえばController View以外すべてがModelとなります。  
例えば、データやそのデータを扱う操作がここに含まれます。   



### DRY原則(Don't repeat yourself)
同じ内容を複数回書くなということです。  
以下の様なシナリオで考えてみたいと思います。  

- Controllerにアクセスした際は、アクセスされた旨と、その日時をログとして書き出すこと。
- 日付のフォーマットはYYYY/MM/DDとする。

1. 上記の仕様を各Controllerに対してログ書き出しを実装していきました。
1. ある日プロジェクトの方針が変更となり、日付のフォーマットはYY/MM/DDとし、  
    アクセスした時間も付与してもらいたい。といった変更要望がきました。
1. 各Controller全てに対して、修正を行いなんとか修正を終わらせました。
1. 後日、ログが古い形式のままであるといった報告を受けてしまいます。
1. すべてのControllerに対して行っていたと思ったログの修正が実は漏れていたため、古い形式で表示されていたのが原因でした。

上記の原因は至ってシンプルで、  
各Controllerに同じような実装(ログ書き出し)を毎回してしまっていたのが原因です。  
対処法としてはどうすればよかったのでしょうか？  

その中の一つして、MVCの思想を理解しておくというのが挙げられます。  
上記の例ではControllerにログ書き出しの実装をその都度実装していました。  
Controllerの責務はModelとViewをつなぐことが責務となります。  
ログ書き出しは上記の責務から明らかに逸脱しています。  
そこを理解した上で考えると、
ログ書き出しをControllerにその都度書くのはおかしいぞ、
といったことに気づけた可能性が出てきます。

もう一つとしては、DRY原則にもとづいて同じ処理が複数回出てきた段階で、  
あれ？これはまとめることができないかといったことを意識する。といったことが挙げられます。  
今回の例においては、ログの書き出しの日付生成は一箇所にまとめておくことが可能です。  
そのようにしておけば、今回のような変更があった際にも変更箇所を最低限にすることで
バグを作り出さないようにすることが可能です。

まぁ、上記の例においては、他にも他人がレビューをしていないとか、  
実装が進んでいるのに、ログの書き出し等根本に関わる仕様がブレるなども問題ではあるのですが・・・

#実装内容解説
前回まではWebアプリケーションとはいえ、画面表示はありませんでした。  
さすがに画面無いのに、アプリケーションとはなんぞ？とツッコまれてしまいそうなので、  
画面を実装してきます。

#### プロジェクト
前回のプロジェクトに対して、更に拡張していきます。  

#### pom.xml
今回用いるThymeleafというライブラリを追加します。  
このライブラリを用いて、
HTMLファイルにControllerで設定したModelの値を反映させます。  

#### src/main/resources/application.yml
Thymeleafはデフォルトでキャッシュを持つため、  
HTMLを更新した際にすぐに反映されないと言ったことが起こります。  
開発中はそれでは、具合が悪いのでキャッシュを無効にしています。  

## Controller から Viewの呼び出し(Model未使用)
#### src/main/java/UserRegister/Controller/showPageController.java
前回作ったcontroller(UserResource.java)では@RestControllerといったアノテーションを付与していましたが、  
今回はJSONではなく、Viewを含めた形で返すので@Controllerといったアノテーションを付与しています。  
  
@RequestMappingに関しては前回と同様です。  
  
最後にviewの指定に関しては、最後の戻り値で指定しています。  
thymeleafでは src/main/resources/templates/ 以下に配置したテンプレート名を返すことで、  
Controllerにアクセスされた際のviewとして指定できます。

#### src/main/resources/templates/index.html
ただのHTMLファイルです。  
Thymeleafの文は一文も記載していません。  
Thymeleafは厳密にXHTMLの文法に準拠する必要があるため、  
下記のようなHTMLはエラーとなります。

    ```HTML
        <meta charset="UTF-8">
        <OPTION value="2" selected>項目２</OPTION>
    ```

一行目は閉じるタグも / もないためエラーとなっています。  
正しくは下記のようにします。

    ```HTML
        <meta charset="UTF-8" />
    ```
    
二行目は右辺の要素が未設定のためエラーとなっています。  
正しくは下記のようにします。

    ```HTML
        <OPTION value="2" selected="true">項目２</OPTION>
    ```


## Controller から Viewの呼び出し(Model使用)
#### src/main/java/UserRegister/Controller/showPageController.java
usersShowメソッド内にModelクラスの引数を設定しています。  
ここにViewに返す値を設定していきます。  
今回はUserRepositoryから取得したユーザー一覧を設定します。  
なお、ユーザー一覧の取得に関しては、前回と同一です。  

modelに対してはaddAttributeメソッドを用います。  
今回の例では第一引数でViewから呼び出す際の名前を、
第二引数でその値をセットしています。  


#### src/main/resources/templates/userList.html
modelの値をviewに表示させるため、HTMLでは見慣れない単語や記法が含まれています。  
th: で始まる箇所がthymeleafの構文となります。  
th:each は繰り返しを展開していく構文になります。

showPageController.java内でusersといった名前で、  
ユーザー一覧をmodelにセットしました。  
これは一覧の形式のため、  
th:eachを用いて一覧から一つずつ要素を取り出しアクセスしていきます。  

